<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Debug - Rude Gyal Confessions</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f9fafb;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #1f2937;
        margin-bottom: 20px;
      }
      .debug-section {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .success {
        background: #dcfce7;
        border-color: #16a34a;
        color: #166534;
      }
      .error {
        background: #fef2f2;
        border-color: #ef4444;
        color: #dc2626;
      }
      .warning {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
      }
      .info {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1d4ed8;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #2563eb;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      pre {
        background: #f3f4f6;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
      input[type="email"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        margin: 5px 0;
      }
      .test-form {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Email System Debug</h1>

      <div id="config-status" class="debug-section info">
        <h3>üìã Configuration Status</h3>
        <p>Checking email configuration...</p>
        <button onclick="checkConfig()">Refresh Configuration</button>
      </div>

      <div class="test-form">
        <h3>üß™ Email Tests</h3>
        <input type="email" id="testEmail" placeholder="your@email.com" />

        <div>
          <button onclick="testEmail()" id="testBtn">Send Test Email</button>
          <button onclick="testPasswordReset()" id="resetBtn">
            Test Password Reset
          </button>
          <button onclick="testDirectResend()" id="directBtn">
            Test Direct Resend
          </button>
        </div>
      </div>

      <div id="test-results" class="debug-section">
        <h3>üìä Test Results</h3>
        <div id="results-content">No tests run yet...</div>
      </div>

      <div id="logs" class="debug-section">
        <h3>üìù Debug Logs</h3>
        <pre id="log-content">Logs will appear here...</pre>
      </div>
    </div>

    <script>
      let logs = [];

      function log(message) {
        const timestamp = new Date().toISOString();
        logs.push(`[${timestamp}] ${message}`);
        document.getElementById("log-content").textContent = logs.join("\n");
      }

      async function checkConfig() {
        log("Checking email configuration...");
        try {
          const response = await fetch("/api/debug-email");
          const data = await response.json();

          const configDiv = document.getElementById("config-status");

          if (data.success) {
            configDiv.className = "debug-section success";
            configDiv.innerHTML = `
              <h3>‚úÖ Configuration Status</h3>
              <p><strong>Environment:</strong> ${data.debug.nodeEnv}</p>
              <p><strong>Resend API Key:</strong> ${data.debug.hasResendKey ? "‚úÖ " + data.debug.resendKeyPrefix : "‚ùå NOT SET"}</p>
              <p><strong>From Email:</strong> ${data.debug.fromEmail}</p>
              <p><strong>Frontend URL:</strong> ${data.debug.frontendUrl}</p>
              <button onclick="checkConfig()">Refresh Configuration</button>
            `;
            log("‚úÖ Configuration check successful");
          } else {
            configDiv.className = "debug-section error";
            configDiv.innerHTML = `
              <h3>‚ùå Configuration Error</h3>
              <p>${data.message}</p>
              <button onclick="checkConfig()">Refresh Configuration</button>
            `;
            log("‚ùå Configuration check failed");
          }
        } catch (error) {
          log(`‚ùå Configuration check error: ${error.message}`);
          document.getElementById("config-status").className =
            "debug-section error";
          document.getElementById("config-status").innerHTML = `
            <h3>‚ùå Configuration Error</h3>
            <p>Failed to check configuration: ${error.message}</p>
            <button onclick="checkConfig()">Refresh Configuration</button>
          `;
        }
      }

      async function testEmail() {
        const email = document.getElementById("testEmail").value;
        if (!email) {
          alert("Please enter an email address");
          return;
        }

        log(`Testing email to: ${email}`);
        document.getElementById("testBtn").disabled = true;
        document.getElementById("testBtn").textContent = "Sending...";

        try {
          const response = await fetch("/api/test-email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();
          showResult("test-email", data);

          if (data.success) {
            log(`‚úÖ Test email sent successfully. Email ID: ${data.emailId}`);
          } else {
            log(`‚ùå Test email failed: ${data.message}`);
          }
        } catch (error) {
          log(`‚ùå Test email error: ${error.message}`);
          showResult("test-email", { success: false, message: error.message });
        }

        document.getElementById("testBtn").disabled = false;
        document.getElementById("testBtn").textContent = "Send Test Email";
      }

      async function testPasswordReset() {
        const email = document.getElementById("testEmail").value;
        if (!email) {
          alert("Please enter an email address");
          return;
        }

        log(`Testing password reset for: ${email}`);
        document.getElementById("resetBtn").disabled = true;
        document.getElementById("resetBtn").textContent = "Sending...";

        try {
          const response = await fetch("/api/auth/forgot-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();
          showResult("password-reset", data);

          if (data.success) {
            log(`‚úÖ Password reset email sent successfully`);
            if (data.resetToken) {
              log(`üîë Reset token: ${data.resetToken}`);
              log(`üîó Reset URL: ${data.resetUrl}`);
            }
          } else {
            log(`‚ùå Password reset failed: ${data.message}`);
          }
        } catch (error) {
          log(`‚ùå Password reset error: ${error.message}`);
          showResult("password-reset", {
            success: false,
            message: error.message,
          });
        }

        document.getElementById("resetBtn").disabled = false;
        document.getElementById("resetBtn").textContent = "Test Password Reset";
      }

      async function testDirectResend() {
        const email = document.getElementById("testEmail").value;
        if (!email) {
          alert("Please enter an email address");
          return;
        }

        log(`Testing direct Resend integration for: ${email}`);
        document.getElementById("directBtn").disabled = true;
        document.getElementById("directBtn").textContent = "Testing...";

        // This would test Resend directly if we had a direct endpoint
        log("Direct Resend test not implemented yet");

        document.getElementById("directBtn").disabled = false;
        document.getElementById("directBtn").textContent = "Test Direct Resend";
      }

      function showResult(testType, data) {
        const resultsDiv = document.getElementById("results-content");
        const resultHtml = `
          <div class="${data.success ? "success" : "error"} debug-section">
            <h4>${testType.toUpperCase()} - ${data.success ? "‚úÖ Success" : "‚ùå Failed"}</h4>
            <p>${data.message}</p>
            ${data.emailId ? `<p><strong>Email ID:</strong> ${data.emailId}</p>` : ""}
            ${data.resetToken ? `<p><strong>Reset Token:</strong> ${data.resetToken}</p>` : ""}
            ${data.resetUrl ? `<p><strong>Reset URL:</strong> <a href="${data.resetUrl}" target="_blank">${data.resetUrl}</a></p>` : ""}
            <small>Timestamp: ${new Date().toLocaleString()}</small>
          </div>
        `;
        resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;
      }

      // Auto-check configuration on page load
      window.onload = function () {
        log("Page loaded, checking configuration...");
        checkConfig();
      };
    </script>
  </body>
</html>
