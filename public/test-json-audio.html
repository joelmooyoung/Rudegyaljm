<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Audio Upload Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      .upload-area {
        border: 2px dashed #ccc;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .status {
        margin: 20px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .loading {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
    </style>
  </head>
  <body>
    <h1>JSON Audio Upload Test</h1>
    <p>Test the new JSON-based audio upload API</p>

    <div class="upload-area">
      <input type="file" id="audioInput" accept="audio/*,.mp3,.wav,.ogg" />
      <p>Select an audio file to upload (Max 4MB for testing)</p>
    </div>

    <div id="status"></div>
    <div id="preview"></div>

    <script>
      function showStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.innerHTML =
          '<div class="status ' + type + '">' + message + "</div>";
      }

      function showPreview(audioUrl, filename, size) {
        const previewDiv = document.getElementById("preview");
        previewDiv.innerHTML =
          "<h3>Upload Successful!</h3>" +
          "<p><strong>Filename:</strong> " +
          filename +
          "</p>" +
          "<p><strong>Size:</strong> " +
          Math.round(size / 1024) +
          " KB</p>" +
          '<p><strong>Data URL:</strong> ' +
          audioUrl.substring(0, 100) +
          "...</p>" +
          '<audio controls><source src="' +
          audioUrl +
          '" type="audio/mpeg">Your browser does not support the audio element.</audio>';
      }

      document
        .getElementById("audioInput")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          console.log("Selected audio file:", {
            name: file.name,
            size: file.size,
            type: file.type,
          });

          // Check file size (4MB limit)
          if (file.size > 4 * 1024 * 1024) {
            showStatus("File too large. Max 4MB for testing.", "error");
            return;
          }

          showStatus("Converting to base64...", "loading");

          try {
            // Step 1: Convert to base64
            console.log("Step 1: Converting file to base64...");
            const base64Audio = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = () => reject(new Error("Failed to read file"));
              reader.readAsDataURL(file);
            });

            console.log("Step 1 complete. Base64 length:", base64Audio.length);
            showStatus("Uploading to server...", "loading");

            // Step 2: Send to server
            console.log("Step 2: Sending to server...");
            const requestData = {
              audioData: base64Audio,
              filename: file.name,
              mimeType: file.type,
              size: file.size,
            };

            console.log("Request data:", {
              ...requestData,
              audioData: requestData.audioData.substring(0, 100) + "...",
            });

            const response = await fetch("/api/upload-audio", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData),
            });

            console.log("Response status:", response.status);
            console.log("Response headers:", Object.fromEntries(response.headers.entries()));

            const result = await response.json();
            console.log("Response result:", result);

            if (response.ok && result.success) {
              showStatus(
                "Audio uploaded successfully: " + result.message,
                "success",
              );
              showPreview(result.audioUrl, result.originalName, result.size);
            } else {
              showStatus(
                "Upload failed: " + (result.error || result.message),
                "error",
              );
            }
          } catch (error) {
            console.error("Upload error:", error);
            showStatus("Upload error: " + error.message, "error");
          }
        });
    </script>
  </body>
</html>
