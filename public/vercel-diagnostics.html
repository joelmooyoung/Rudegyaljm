<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vercel Environment Diagnostics</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        background: #1a1a1a;
        color: #00ff00;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      .section {
        background: #2a2a2a;
        border: 1px solid #00ff00;
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
      }
      .error {
        color: #ff4444;
      }
      .success {
        color: #44ff44;
      }
      .warning {
        color: #ffaa44;
      }
      .info {
        color: #4444ff;
      }
      button {
        background: #00aa00;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        border-radius: 3px;
      }
      button:hover {
        background: #00cc00;
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
      }
      pre {
        background: #111;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-ok {
        background: #44ff44;
      }
      .status-error {
        background: #ff4444;
      }
      .status-unknown {
        background: #ffaa44;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Vercel Environment Diagnostics</h1>
      <p class="info">
        This page helps diagnose connection issues between your app and MongoDB
      </p>

      <div class="section">
        <h2>üìç Current Environment</h2>
        <div id="environment-info">
          <p><strong>URL:</strong> <span id="current-url"></span></p>
          <p><strong>Host:</strong> <span id="current-host"></span></p>
          <p><strong>Protocol:</strong> <span id="current-protocol"></span></p>
          <p><strong>User Agent:</strong> <span id="user-agent"></span></p>
        </div>
      </div>

      <div class="section">
        <h2>üîå Connection String Tester</h2>
        <p>Enter your MongoDB connection string to validate format:</p>
        <input
          type="text"
          id="mongo-uri"
          placeholder="mongodb+srv://username:password@cluster.mongodb.net/database"
          style="
            width: 100%;
            padding: 8px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
          "
        />
        <br /><br />
        <button onclick="validateConnectionString()">Validate Format</button>
        <button onclick="showMongoCommands()">Generate MongoDB Commands</button>
        <div id="connection-results"></div>
      </div>

      <div class="section">
        <h2>üåê API Endpoint Tests</h2>
        <p>Test if your Vercel API endpoints are accessible:</p>
        <button onclick="testEndpoint('/api/ping')">Test /api/ping</button>
        <button onclick="testEndpoint('/api/stories')">
          Test /api/stories
        </button>
        <button onclick="testEndpoint('/api/debug-connection')">
          Test /api/debug-connection
        </button>
        <button onclick="testAllEndpoints()">Test All</button>
        <div id="api-results"></div>
      </div>

      <div class="section">
        <h2>üìä Database Verification</h2>
        <p>Use these commands in MongoDB Compass to verify your database:</p>
        <button onclick="showDatabaseCommands()">Show Database Commands</button>
        <div id="database-commands"></div>
      </div>

      <div class="section">
        <h2>üéØ Quick Login Test</h2>
        <p>Test login with seeded accounts (if database is working):</p>
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
          "
        >
          <div>
            <strong>Email:</strong>
            <input
              type="email"
              id="test-email"
              value="admin@nocturne.com"
              style="
                width: 100%;
                padding: 5px;
                background: #333;
                color: #fff;
                border: 1px solid #555;
              "
            />
          </div>
          <div>
            <strong>Password:</strong>
            <input
              type="password"
              id="test-password"
              value="admin123"
              style="
                width: 100%;
                padding: 5px;
                background: #333;
                color: #fff;
                border: 1px solid #555;
              "
            />
          </div>
        </div>
        <button onclick="testLogin()">Test Login</button>
        <div id="login-results"></div>
      </div>

      <div class="section">
        <h2>üìã Environment Variables Check</h2>
        <p>These should be set in your Vercel project settings:</p>
        <ul>
          <li>
            <span class="status-indicator status-unknown"></span
            ><strong>MONGODB_URI:</strong> Your MongoDB connection string
          </li>
          <li>
            <span class="status-indicator status-unknown"></span
            ><strong>NODE_ENV:</strong> Should be "production"
          </li>
        </ul>
        <button onclick="checkVercelEnv()">Check Environment (via API)</button>
        <div id="env-results"></div>
      </div>
    </div>

    <script>
      // Initialize page
      document.getElementById("current-url").textContent = window.location.href;
      document.getElementById("current-host").textContent =
        window.location.hostname;
      document.getElementById("current-protocol").textContent =
        window.location.protocol;
      document.getElementById("user-agent").textContent =
        navigator.userAgent.substring(0, 100) + "...";

      function validateConnectionString() {
        const uri = document.getElementById("mongo-uri").value;
        const results = document.getElementById("connection-results");

        if (!uri) {
          results.innerHTML =
            '<p class="error">Please enter a connection string</p>';
          return;
        }

        let isValid = true;
        let issues = [];

        if (
          !uri.startsWith("mongodb+srv://") &&
          !uri.startsWith("mongodb://")
        ) {
          isValid = false;
          issues.push("Must start with mongodb+srv:// or mongodb://");
        }

        if (!uri.includes("@")) {
          isValid = false;
          issues.push(
            "Missing @ symbol (should be between credentials and host)",
          );
        }

        if (
          !uri.includes("/") ||
          uri.lastIndexOf("/") === uri.indexOf("//") + 1
        ) {
          isValid = false;
          issues.push("Missing database name after hostname");
        }

        if (isValid) {
          results.innerHTML =
            '<p class="success">‚úÖ Connection string format is valid!</p>';
        } else {
          results.innerHTML =
            '<p class="error">‚ùå Connection string issues:</p><ul>' +
            issues
              .map((issue) => '<li class="error">' + issue + "</li>")
              .join("") +
            "</ul>";
        }
      }

      function showMongoCommands() {
        const uri = document.getElementById("mongo-uri").value;
        const results = document.getElementById("connection-results");

        if (!uri) {
          results.innerHTML =
            '<p class="error">Enter connection string first</p>';
          return;
        }

        results.innerHTML = `
                <h3>MongoDB Compass Commands:</h3>
                <p>1. Connect to: <code>${uri}</code></p>
                <p>2. Run these commands in MongoDB shell:</p>
                <pre>
// Check if database exists
show databases;

// Switch to your database  
use('rude-gyal-confessions');

// Check collections
show collections;

// Count documents
db.users.countDocuments();
db.stories.countDocuments();

// Find admin user
db.users.findOne({email: "admin@nocturne.com"});
                </pre>
            `;
      }

      async function testEndpoint(endpoint) {
        const results = document.getElementById("api-results");
        const baseUrl =
          window.location.protocol + "//" + window.location.hostname;
        const fullUrl = baseUrl + endpoint;

        results.innerHTML += `<p>Testing: ${fullUrl}</p>`;

        try {
          const response = await fetch(fullUrl, {
            method: "GET",
            mode: "cors",
          });

          if (response.ok) {
            const data = await response.json();
            results.innerHTML += `<p class="success">‚úÖ ${endpoint}: ${response.status} OK</p>`;
            results.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
          } else {
            results.innerHTML += `<p class="error">‚ùå ${endpoint}: ${response.status} ${response.statusText}</p>`;
          }
        } catch (error) {
          results.innerHTML += `<p class="error">‚ùå ${endpoint}: ${error.message}</p>`;
        }
      }

      async function testAllEndpoints() {
        document.getElementById("api-results").innerHTML =
          "<h3>Testing all endpoints...</h3>";
        await testEndpoint("/api/ping");
        await testEndpoint("/api/stories");
        await testEndpoint("/api/debug-connection");
      }

      async function testLogin() {
        const email = document.getElementById("test-email").value;
        const password = document.getElementById("test-password").value;
        const results = document.getElementById("login-results");
        const baseUrl =
          window.location.protocol + "//" + window.location.hostname;

        results.innerHTML = "<p>Testing login...</p>";

        try {
          const response = await fetch(baseUrl + "/api/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            results.innerHTML = `<p class="success">‚úÖ Login successful!</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
          } else {
            results.innerHTML = `<p class="error">‚ùå Login failed: ${response.status}</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
          }
        } catch (error) {
          results.innerHTML = `<p class="error">‚ùå Login error: ${error.message}</p>`;
        }
      }

      function showDatabaseCommands() {
        document.getElementById("database-commands").innerHTML = `
                <h3>Database Verification Commands:</h3>
                <pre>
// 1. Check database exists
show databases;

// 2. Use your database
use('rude-gyal-confessions');

// 3. Check collections
show collections;

// 4. Verify user accounts
db.users.find({}, {email: 1, type: 1, active: 1});

// 5. Check stories
db.stories.find({}, {title: 1, author: 1, published: 1});

// 6. Test admin login data
db.users.findOne({email: "admin@nocturne.com"});
                </pre>
                <p class="info">Copy these commands and run them in MongoDB Compass shell to verify your data exists.</p>
            `;
      }

      async function checkVercelEnv() {
        const results = document.getElementById("env-results");
        results.innerHTML = "<p>Checking environment via API...</p>";

        try {
          const response = await fetch("/api/env-check");
          if (response.ok) {
            const data = await response.json();
            results.innerHTML = `<p class="success">‚úÖ Environment check successful</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
          } else {
            results.innerHTML = `<p class="error">‚ùå Environment check failed: ${response.status}</p>`;
          }
        } catch (error) {
          results.innerHTML = `<p class="error">‚ùå Cannot reach environment check endpoint</p>`;
        }
      }
    </script>
  </body>
</html>
